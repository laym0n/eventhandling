# EventHandling (Outbox/Inbox)

## Requirements
- Сохранение события для обработки **MUST**
    - Возможность с каждым событием сохранять кастомную полезную нагрузку для обработки события (Payload) **MUST**
    - Наличие у каждого события названия **MUST**
    - API для сохранения события **MUST**
- Обработка сохраненных событий **MUST**
    - API для реализации обработчиков событий по названиям событий **MUST**
    - Гарантия at least once обработки события **MUST**
    - Конфигурация количества ретраев на случай неуспеха обработки событий **SHOULD**
    - Конфигурация количества ретраев на случай неуспеха обработки отдельных событий по их названиям **WON'T**
    - Сохранение неудачно обработанных событий для последующих разборов **SHOULD**
    - Мониторинг необработанных событий (логирование, Тенгри и Рефлекс) **SHOULD**
    - Partial order (Последовательность обработки событий в рамках одного groupId, например идентифкатор заявки) **COULD**
    - Обработка по приоритетам, а не по FIFO **WON'T**
    - Конфигурация обработки событий в несколько потоков **SHOULD**
    - Гарантированность нестухания в очереди (сообщение, добавленное в очередь успеет начать обрабатываться до того как наступит expired_at) **SHOULD**
- Очистка обработанных сообщений **MUST**
- Очистка старых необработанных сообщений **SHOULD**

### MoSCoW

- MUST - требования обязательные для успеха
- SHOULD - важные, но необязательные требования
- COULD - требования, которые оказывают минимальное влияение и неплохо было бы их реализовать в последнюю очередь 
- WON'T - требования, которые не признаны приоритетными и не будут реализованы в ближайший релиз

## System Design

| Название | Тип | Описание |
|----------|-----|-----------|
| `id` | `UUID` ||
| `event_name` | `VARCHAR(100)` | **Название события** - определяет, какой обработчик должен его обработать |
| `payload` | `JSONB` | **Полезная нагрузка** - кастомные данные события для обработки. `JSONB` для эффективного хранения и запросов |
| `status` | `VARCHAR(50)` | Статус обработки: `'pending'`, `'processing'`, `'processed'`, `'failed'` |
| `attempt` | `INTEGER` | Количество попыток обработки. Начинается с 0 |
| `max_attempts` | `INTEGER` | Максимальное количество ретраев при неудаче (конфигурация) |
| `group_id` | `VARCHAR(255)` | **Group ID** для обеспечения Partial Order - гарантирует порядок обработки событий в рамках одной группы |
| `created_at` | `TIMESTAMPTZ` | Дата и время создания события. Используется для очистки старых записей |
| `processed_at` | `TIMESTAMPTZ` | Дата и время успешной обработки. Используется для очистки обработанных сообщений |
| `expired_at` | `TIMESTAMPTZ` | Дата и время, до которого событие должно быть обработано. Обеспечивает "гарантированность нестухания" |
| `last_error` | `TEXT` | Текст последней ошибки при обработке. Для анализа неудачных событий |
| `metadata` | `JSONB` | Дополнительные метаданные (источник события, версия, техническая информация) |

**Ключевые моменты, соответствующие требованиям:**

- **`event_name` + `payload`** - закрывают требования по названию и кастомной полезной нагрузке
- **`status` + `attempt` + `max_attempts`** - обеспечивают at least once доставку с конфигурируемыми ретраями
- **`group_id`** - позволяет реализовать Partial Order
- **`created_at` + `processed_at` + `expired_at`** - обеспечивают очистку и гарантию нестухания
- **`last_error`** - помогает в анализе неудачно обработанных событий

**Дополнительные рекомендации по индексам:**
```sql
-- Для выборки событий на обработку
CREATE INDEX idx_event_pending ON event (status, expired_at) 
WHERE status IN ('pending', 'failed');

-- Для Partial Order обработки
CREATE INDEX idx_event_group_pending ON event (group_id, status, created_at);

-- Для очистки
CREATE INDEX idx_event_processed_cleanup ON event (status, processed_at);
CREATE INDEX idx_event_failed_cleanup ON event (status, created_at);
```

### Очистка обработанных сообщений

#### Периодическая очистка - альтернатива 1

#### Очистка сразу после обработки - альтернатива 2

### Сохранение неудачно обработанных сообщений

#### Сохранение в той же таблице - альтернатива 1


#### Сохранение в таблице dead_events - альтернатива 2

### Обработка событий

#### Обработка одним инстансом приложения - альтернатива 1

#### Обработка несколькими инстансами приложения - альтернатива 2

### Обработка неуспешных событий

#### Увеличение счетчика попыток обработки - альтернатива 1

#### Повторная попытка обработки сразу в приложении - альтернатива 2